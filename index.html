import React, { useState, useEffect } from 'react';
import { LineChart, Line, BarChart, Bar, PieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import { TrendingUp, Users, DollarSign, ShoppingCart, MessageSquare, Send, Sparkles, Upload, FileText, Check } from 'lucide-react';
import Papa from 'papaparse';

const MonthlyDashboard = () => {
  const [chatMessages, setChatMessages] = useState([
    { role: 'assistant', content: 'Bonjour ! Importez votre fichier FEC pour commencer l\'analyse, ou posez-moi des questions sur les données affichées.' }
  ]);
  const [inputMessage, setInputMessage] = useState('');
  const [currentMonth] = useState('Octobre 2025');
  const [fecData, setFecData] = useState(null);
  const [isFileLoaded, setIsFileLoaded] = useState(false);
  const [fileName, setFileName] = useState('');

  // Données par défaut (exemples)
  const [dashboardData, setDashboardData] = useState({
    monthlyRevenue: [
      { name: 'Sem 1', revenus: 35000, depenses: 5300 },
      { name: 'Sem 2', revenus: 30000, depenses: 6120 },
      { name: 'Sem 3', revenus: 32000, depenses: 5490 },
      { name: 'Sem 4', revenus: 33000, depenses: 5150 }
    ],
    categoryData: [
      { name: 'Ventes produits', value: 104000, color: '#3b82f6' },
      { name: 'Prestations de services', value: 26000, color: '#8b5cf6' },
      { name: 'Autres produits', value: 0, color: '#10b981' },
      { name: 'Divers', value: 0, color: '#f59e0b' }
    ],
    kpiData: [
      { icon: DollarSign, label: 'Revenus', value: '130.0K€', change: '+12.5%', positive: true },
      { icon: FileText, label: 'Écritures', value: '72', change: '+5.1%', positive: true },
      { icon: ShoppingCart, label: 'Dépenses', value: '22.1K€', change: '+3.2%', positive: true },
      { icon: TrendingUp, label: 'Marge', value: '83.0%', change: '+1.2%', positive: true }
    ]
  });

  const handleFileUpload = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    setFileName(file.name);

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      delimiter: '\t', // FEC est généralement séparé par des tabulations
      complete: (results) => {
        const data = results.data;
        setFecData(data);
        setIsFileLoaded(true);
        
        // Analyse automatique du FEC
        analyzeFEC(data);
        
        setChatMessages(prev => [...prev, 
          { role: 'assistant', content: `✅ Fichier FEC importé avec succès ! J'ai analysé ${data.length} écritures comptables. Je peux maintenant répondre à vos questions sur vos données réelles.` }
        ]);
      },
      error: (error) => {
        setChatMessages(prev => [...prev, 
          { role: 'assistant', content: `❌ Erreur lors de l'import du fichier : ${error.message}. Assurez-vous qu'il s'agit d'un fichier FEC valide.` }
        ]);
      }
    });
  };

  const analyzeFEC = (data) => {
    try {
      // Calcul des revenus et dépenses
      let totalRevenue = 0;
      let totalExpenses = 0;
      let entriesCount = data.length;
      
      const revenuesByWeek = {};
      const expensesByWeek = {};
      const categoriesMap = {};

      data.forEach(row => {
        // Nettoyage des en-têtes (espaces)
        const cleanRow = {};
        Object.keys(row).forEach(key => {
          cleanRow[key.trim()] = row[key];
        });

        const debit = parseFloat(cleanRow.Debit || cleanRow.Montant || 0);
        const credit = parseFloat(cleanRow.Credit || cleanRow['Montantau crédit'] || 0);
        const compte = cleanRow.CompteNum || cleanRow['Numéro de compte'] || '';
        const libelle = cleanRow.CompteLib || cleanRow.Libellé || cleanRow.EcritureLib || '';
        const date = cleanRow.EcritureDate || cleanRow.Date || '';

        // Classification des comptes (plan comptable français)
        if (compte.startsWith('7')) {
          totalRevenue += credit;
          const week = getWeekNumber(date);
          revenuesByWeek[week] = (revenuesByWeek[week] || 0) + credit;
          
          // Catégorisation
          const category = getCategoryFromAccount(compte, libelle);
          categoriesMap[category] = (categoriesMap[category] || 0) + credit;
        } else if (compte.startsWith('6')) {
          totalExpenses += debit;
          const week = getWeekNumber(date);
          expensesByWeek[week] = (expensesByWeek[week] || 0) + debit;
        }
      });

      // Préparation des données pour les graphiques
      const weeks = ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'];
      const monthlyRevenue = weeks.map((week, idx) => ({
        name: week,
        revenus: Math.round(revenuesByWeek[idx + 1] || 0),
        depenses: Math.round(expensesByWeek[idx + 1] || 0)
      }));

      const colors = ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444'];
      const categoryData = Object.entries(categoriesMap).map(([name, value], idx) => ({
        name,
        value: Math.round(value),
        color: colors[idx % colors.length]
      }));

      const margin = totalRevenue > 0 ? ((totalRevenue - totalExpenses) / totalRevenue * 100).toFixed(1) : 0;

      const kpiData = [
        { icon: DollarSign, label: 'Revenus', value: formatCurrency(totalRevenue), change: '+12.5%', positive: true },
        { icon: FileText, label: 'Écritures', value: entriesCount.toString(), change: '+5.1%', positive: true },
        { icon: ShoppingCart, label: 'Dépenses', value: formatCurrency(totalExpenses), change: '+3.2%', positive: true },
        { icon: TrendingUp, label: 'Marge', value: `${margin}%`, change: '+1.2%', positive: true }
      ];

      setDashboardData({
        monthlyRevenue,
        categoryData: categoryData.length > 0 ? categoryData : dashboardData.categoryData,
        kpiData
      });

    } catch (error) {
      console.error('Erreur analyse FEC:', error);
    }
  };

  const getWeekNumber = (dateStr) => {
    if (!dateStr) return 1;
    try {
      const date = new Date(dateStr);
      const day = date.getDate();
      return Math.ceil(day / 7);
    } catch {
      return 1;
    }
  };

  const getCategoryFromAccount = (compte, libelle) => {
    if (compte.startsWith('70')) return 'Ventes produits';
    if (compte.startsWith('71')) return 'Production stockée';
    if (compte.startsWith('72')) return 'Production immobilisée';
    if (compte.startsWith('74')) return 'Subventions';
    if (compte.startsWith('75')) return 'Autres produits';
    if (compte.startsWith('76')) return 'Produits financiers';
    if (compte.startsWith('77')) return 'Produits exceptionnels';
    if (compte.startsWith('78')) return 'Reprises';
    return 'Autres';
  };

  const formatCurrency = (value) => {
    if (value >= 1000000) return `${(value / 1000000).toFixed(1)}M€`;
    if (value >= 1000) return `${(value / 1000).toFixed(1)}K€`;
    return `${value.toFixed(0)}€`;
  };

  const aiResponses = {
    fec: "Le format FEC (Fichier des Écritures Comptables) est le format standard pour l'export des données comptables en France. Cliquez sur le bouton 'Importer FEC' et sélectionnez votre fichier (généralement .txt ou .csv).",
    revenus: `D'après votre fichier FEC, vos revenus totaux sont de ${dashboardData.kpiData[0].value}. ${isFileLoaded ? 'Ces données proviennent de vos écritures comptables réelles.' : 'Importez votre FEC pour voir vos données réelles.'}`,
    comptes: "Les comptes de classe 7 représentent les produits (revenus), et les comptes de classe 6 représentent les charges (dépenses). Je les ai analysés automatiquement dans votre FEC.",
    default: isFileLoaded 
      ? "Je peux vous aider à analyser votre FEC. Posez-moi des questions sur vos revenus, dépenses, comptes ou écritures comptables." 
      : "Importez d'abord votre fichier FEC pour que je puisse analyser vos données comptables réelles !"
  };

  const handleSendMessage = () => {
    if (!inputMessage.trim()) return;

    const userMessage = { role: 'user', content: inputMessage };
    setChatMessages(prev => [...prev, userMessage]);

    setTimeout(() => {
      let response = aiResponses.default;
      const msg = inputMessage.toLowerCase();
      
      if (msg.includes('fec') || msg.includes('import') || msg.includes('fichier')) {
        response = aiResponses.fec;
      } else if (msg.includes('revenu') || msg.includes('chiffre')) {
        response = aiResponses.revenus;
      } else if (msg.includes('compte') || msg.includes('classe')) {
        response = aiResponses.comptes;
      } else if (fecData && (msg.includes('analyse') || msg.includes('données'))) {
        response = `J'ai analysé ${fecData.length} écritures comptables de votre FEC. Les revenus totaux sont de ${dashboardData.kpiData[0].value} et les dépenses de ${dashboardData.kpiData[2].value}. Que souhaitez-vous savoir de plus ?`;
      }

      setChatMessages(prev => [...prev, { role: 'assistant', content: response }]);
    }, 800);

    setInputMessage('');
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="mb-8 flex justify-between items-center">
          <div>
            <h1 className="text-4xl font-bold text-white mb-2">Dashboard Comptable</h1>
            <p className="text-purple-300 text-lg">{currentMonth}</p>
          </div>
          
          {/* Import FEC Button */}
          <div className="relative">
            <input
              type="file"
              id="fec-upload"
              accept=".txt,.csv"
              onChange={handleFileUpload}
              className="hidden"
            />
            <label
              htmlFor="fec-upload"
              className="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg cursor-pointer transition-colors"
            >
              {isFileLoaded ? <Check className="w-5 h-5" /> : <Upload className="w-5 h-5" />}
              {isFileLoaded ? 'FEC Chargé' : 'Importer FEC'}
            </label>
            {fileName && (
              <p className="text-xs text-purple-300 mt-2 text-right">{fileName}</p>
            )}
          </div>
        </div>

        {/* Status Bar */}
        {isFileLoaded && (
          <div className="mb-6 bg-green-500/20 border border-green-500/40 rounded-lg p-4">
            <div className="flex items-center gap-2 text-green-300">
              <Check className="w-5 h-5" />
              <span className="font-medium">Fichier FEC importé - {fecData?.length || 0} écritures analysées</span>
            </div>
          </div>
        )}

        {/* KPI Cards */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          {dashboardData.kpiData.map((kpi, idx) => (
            <div key={idx} className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
              <div className="flex items-center justify-between mb-4">
                <kpi.icon className="w-8 h-8 text-purple-400" />
                <span className={`text-sm font-semibold ${kpi.positive ? 'text-green-400' : 'text-red-400'}`}>
                  {kpi.change}
                </span>
              </div>
              <p className="text-gray-300 text-sm mb-1">{kpi.label}</p>
              <p className="text-3xl font-bold text-white">{kpi.value}</p>
            </div>
          ))}
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Charts Section */}
          <div className="lg:col-span-2 space-y-6">
            {/* Revenue Chart */}
            <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
              <h3 className="text-xl font-semibold text-white mb-4">Revenus & Dépenses Mensuels</h3>
              <ResponsiveContainer width="100%" height={250}>
                <LineChart data={dashboardData.monthlyRevenue}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#ffffff20" />
                  <XAxis dataKey="name" stroke="#fff" />
                  <YAxis stroke="#fff" />
                  <Tooltip 
                    contentStyle={{ backgroundColor: '#1e1b4b', border: '1px solid #8b5cf6' }}
                    labelStyle={{ color: '#fff' }}
                  />
                  <Legend />
                  <Line type="monotone" dataKey="revenus" stroke="#3b82f6" strokeWidth={3} />
                  <Line type="monotone" dataKey="depenses" stroke="#ef4444" strokeWidth={3} />
                </LineChart>
              </ResponsiveContainer>
            </div>

            {/* Category Chart */}
            <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
              <h3 className="text-xl font-semibold text-white mb-4">Répartition par Catégorie</h3>
              <div className="flex items-center justify-between">
                <ResponsiveContainer width="50%" height={200}>
                  <PieChart>
                    <Pie
                      data={dashboardData.categoryData}
                      cx="50%"
                      cy="50%"
                      outerRadius={80}
                      dataKey="value"
                      label
                    >
                      {dashboardData.categoryData.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={entry.color} />
                      ))}
                    </Pie>
                    <Tooltip />
                  </PieChart>
                </ResponsiveContainer>
                <div className="space-y-3">
                  {dashboardData.categoryData.map((cat, idx) => (
                    <div key={idx} className="flex items-center gap-3">
                      <div className="w-4 h-4 rounded" style={{ backgroundColor: cat.color }}></div>
                      <div>
                        <p className="text-white font-medium">{cat.name}</p>
                        <p className="text-gray-400 text-sm">{cat.value.toLocaleString()}€</p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>

          {/* AI Chat Section */}
          <div className="bg-white/10 backdrop-blur-lg rounded-xl border border-white/20 flex flex-col h-[600px]">
            <div className="p-4 border-b border-white/20 flex items-center gap-2">
              <Sparkles className="w-6 h-6 text-purple-400" />
              <h3 className="text-xl font-semibold text-white">Assistant IA</h3>
            </div>
            
            <div className="flex-1 overflow-y-auto p-4 space-y-4">
              {chatMessages.map((msg, idx) => (
                <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                  <div className={`max-w-[85%] rounded-lg p-3 ${
                    msg.role === 'user' 
                      ? 'bg-purple-600 text-white' 
                      : 'bg-white/20 text-gray-100'
                  }`}>
                    {msg.role === 'assistant' && (
                      <Sparkles className="w-4 h-4 inline mr-2 text-purple-400" />
                    )}
                    <span className="text-sm">{msg.content}</span>
                  </div>
                </div>
              ))}
            </div>

            <div className="p-4 border-t border-white/20">
              <div className="flex gap-2">
                <input
                  type="text"
                  value={inputMessage}
                  onChange={(e) => setInputMessage(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                  placeholder="Posez une question..."
                  className="flex-1 bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
                />
                <button
                  onClick={handleSendMessage}
                  className="bg-purple-600 hover:bg-purple-700 text-white rounded-lg px-4 py-2 transition-colors"
                >
                  <Send className="w-5 h-5" />
                </button>
              </div>
              <p className="text-xs text-gray-400 mt-2">
                Essayez : "Analyse mon FEC", "Quels sont mes revenus ?", "Explique les comptes"
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default MonthlyDashboard;
