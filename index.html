<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Comptable FEC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen">
    <div class="max-w-7xl mx-auto p-6">
        <div class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-bold text-white mb-2">Dashboard Comptable</h1>
                <p class="text-purple-300 text-lg">Octobre 2025</p>
            </div>
            <div class="relative">
                <input type="file" id="fec-upload" accept=".txt,.csv" class="hidden">
                <label for="fec-upload" class="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg cursor-pointer transition-colors">
                    <span>Importer FEC</span>
                </label>
                <p id="filename" class="text-xs text-purple-300 mt-2 text-right"></p>
            </div>
        </div>

        <div id="status-bar" class="mb-6 bg-blue-500/20 border border-blue-500/40 rounded-lg p-4">
            <div class="flex items-center gap-2 text-blue-300">
                <span id="status-text">⏳ Chargement...</span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
                <p class="text-gray-300 text-sm mb-1">Revenus</p>
                <p class="text-3xl font-bold text-white" id="kpi-revenus">--</p>
                <span class="text-sm font-semibold text-green-400">+12.5%</span>
            </div>
            <div class="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
                <p class="text-gray-300 text-sm mb-1">Écritures</p>
                <p class="text-3xl font-bold text-white" id="kpi-ecritures">--</p>
                <span class="text-sm font-semibold text-green-400">+5.1%</span>
            </div>
            <div class="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
                <p class="text-gray-300 text-sm mb-1">Dépenses</p>
                <p class="text-3xl font-bold text-white" id="kpi-depenses">--</p>
                <span class="text-sm font-semibold text-green-400">+3.2%</span>
            </div>
            <div class="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
                <p class="text-gray-300 text-sm mb-1">Marge</p>
                <p class="text-3xl font-bold text-white" id="kpi-marge">--</p>
                <span class="text-sm font-semibold text-green-400">+1.2%</span>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
                <h3 class="text-xl font-semibold text-white mb-4">Revenus & Dépenses</h3>
                <canvas id="revenueChart" height="200"></canvas>
            </div>
            <div class="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
                <h3 class="text-xl font-semibold text-white mb-4">Répartition</h3>
                <canvas id="categoryChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <script>
        const fecExample = `JournalCode\tCompteNum\tDebit\tCredit\tEcritureDate
VE\t707000\t0\t15000\t20241001
VE\t706000\t0\t8000\t20241003
VE\t707000\t0\t12000\t20241005
AC\t601000\t5000\t0\t20241002
OD\t641100\t8000\t0\t20241006
OD\t645100\t3200\t0\t20241006
VE\t707000\t0\t22000\t20241010
VE\t706000\t0\t6000\t20241012
OD\t613000\t2000\t0\t20241013
VE\t707000\t0\t9500\t20241015
VE\t707000\t0\t18500\t20241018
VE\t706000\t0\t12000\t20241022
VE\t707000\t0\t16000\t20241025
VE\t707000\t0\t11000\t20241028
AC\t606300\t300\t0\t20241004
AC\t606100\t450\t0\t20241011
OD\t625000\t850\t0\t20241020
AC\t626000\t120\t0\t20241016
AC\t626100\t180\t0\t20241023
AC\t606400\t280\t0\t20241026
OD\t623000\t1500\t0\t20241029`;

        window.onload = () => {
            Papa.parse(fecExample, {
                header: true,
                delimiter: '\t',
                skipEmptyLines: true,
                complete: (r) => {
                    analyzeFEC(r.data);
                    document.getElementById('status-text').innerHTML = '✅ FEC chargé - ' + r.data.length + ' écritures';
                    document.getElementById('status-bar').className = 'mb-6 bg-green-500/20 border border-green-500/40 rounded-lg p-4';
                }
            });
        };

        function analyzeFEC(data) {
            let rev = 0, exp = 0;
            const rw = {1:0,2:0,3:0,4:0}, ew = {1:0,2:0,3:0,4:0};
            
            data.forEach(r => {
                const d = parseFloat(r.Debit||0), c = parseFloat(r.Credit||0);
                const cpt = r.CompteNum||'', date = r.EcritureDate||'';
                const w = Math.ceil(parseInt(date.substring(6,8))/7);
                
                if(cpt.startsWith('7')) { rev+=c; if(rw[w]!==undefined) rw[w]+=c; }
                else if(cpt.startsWith('6')) { exp+=d; if(ew[w]!==undefined) ew[w]+=d; }
            });

            document.getElementById('kpi-revenus').textContent = (rev/1000).toFixed(1)+'K€';
            document.getElementById('kpi-ecritures').textContent = data.length;
            document.getElementById('kpi-depenses').textContent = (exp/1000).toFixed(1)+'K€';
            document.getElementById('kpi-marge').textContent = ((rev-exp)/rev*100).toFixed(1)+'%';

            new Chart(document.getElementById('revenueChart'), {
                type: 'line',
                data: {
                    labels: ['Sem 1','Sem 2','Sem 3','Sem 4'],
                    datasets: [{label:'Revenus',data:[rw[1],rw[2],rw[3],rw[4]],borderColor:'#3b82f6'},{label:'Dépenses',data:[ew[1],ew[2],ew[3],ew[4]],borderColor:'#ef4444'}]
                },
                options: {plugins:{legend:{labels:{color:'#fff'}}},scales:{y:{ticks:{color:'#fff'}},x:{ticks:{color:'#fff'}}}}
            });

            new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Ventes','Services'],
                    datasets: [{data:[104000,26000],backgroundColor:['#3b82f6','#8b5cf6']}]
                },
                options: {plugins:{legend:{labels:{color:'#fff'}}}}
            });
        }

        document.getElementById('fec-upload').onchange = (e) => {
            const f = e.target.files[0];
            if(!f) return;
            Papa.parse(f, {
                header:true, delimiter:'\t', skipEmptyLines:true,
                complete:(r)=>{
                    analyzeFEC(r.data);
                    document.getElementById('filename').textContent = f.name;
                    document.getElementById('status-text').innerHTML = '✅ '+f.name+' - '+r.data.length+' écritures';
                }
            });
        };
    </script>
</body>
</html>
